#!/bin/bash

#Read input from strace of the shell and isolates and formats the keystrokes from the shell
function keylogger() {
  process_on="$(ps -A | grep $1)"
  #Check for new data
  if [ -s rawkey.txt ] ; then
    python -c "import func; func.parse_rawkeys();"
  fi
}

function detect_shell() {
  shell_detect=false
  while [ "$shell_detect" != true ] ; do
    #Check for a 'bash' or 'sh' shell that is connected to a remote internet address. Get the PID
    shell_pid="$(lsof -i | grep -w -e 'bash' -e 'sh' | awk '{print $2}' | head -n1 )"

    #If a shell process has been detected
    if [ "$shell_pid" != "" ] ; then
      shell_detect=true
      echo "!-------------------------!"
      echo "A new shell process has been detected with PID: $shell_pid"
      remote_IP="$(lsof -i | grep $shell_pid| awk '{print $8}'| head -n1| sed -n -e 's/^.*->//p' )"
      echo "From IP: $remote_IP"
      echo ">>>>>>>>>>>>>>>>>>"
      #Notify the user by email
      python -c "import mail;mail.email_alert('$remote_IP')"
    fi
  done
}
