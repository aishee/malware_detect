#!/usr/bin/python

import smtplib
import poplib
from email import parser

#Send email
def send_email(msg):
    server = smtplib.SMTP('smtp.gmail.com', 587)
    server.ehlo()
    server.starttls()
    server.login("", "")
    server.sendmail("", "", msg)
    server.quit()

#Alert owner email
def email_alert(IP):
    msg = "ATTENTION YOU! \n A potential shell process has been detected on your beloved computer \n Dont stress too much! It is being monitored. \n The connection is from: " + IP + "\nReply to this message in the subject line with: \n END - to terminal shell \n LOG - to recieve an email wwith keystrokes"
    send_email(msg)

#Email user with keystrokes log
def email_log():
    log_msg = 'The following keystrokes have been recorded:'
    file = open('keystrokes.log', 'r')
    for line in file:
        log_msg += "\n" + line
    file.close()
    send_email(log_msg)

#Checks for latest email in inbox
def check_email():
    pop_conn = poplib.POP3_SSL('pop.gmail.com')
    pop_conn.user('')
    pop_conn.pass_('')
    #Get messages from server:
    messages = [pop_conn.retr(i) for i in range(1, len(pop_conn.list()[1]) + 1)]
    #Concat message pieces:
    messages = ["\n".join(mssg[1] for mssg in messages)]
    #Parse message intom an email object:
    messages = [parser.Parser().parsestr(mssg) fro mssg in messages]
    for message in messages:
        print message['subject']
    pop_conn.quit()
